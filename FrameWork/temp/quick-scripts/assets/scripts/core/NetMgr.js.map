{"version":3,"sources":["NetMgr.js"],"names":["window","io","require","NetMgr","cc","Class","statics","ip","sio","isPinging","fnDisconnect","handlers","addHandler","event","fn","console","log","handler","data","toString","JSON","parse","on","connect","fnConnect","fnError","self","opts","connected","close","key","value","startHearbeat","lastRecieveTime","Date","now","delayMS","lastSendTime","game","EVENT_HIDE","ping","setInterval","bind","send","stringify","emit","disconnect","module","exports"],"mappings":"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","file":"NetMgr.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\core","sourcesContent":["//网络工具\r\n//在优先使用websocket 否则才使用第三方 socketio\r\nif(window.io == null){\r\n    window.io = require(\"socket-io\");\r\n}\r\nvar NetMgr = cc.Class({\r\n    statics: {\r\n        ip:\"\",\r\n        sio:null,\r\n        isPinging:false,\r\n        fnDisconnect:null,//断线重连\r\n        handlers:{},//回调\r\n\r\n        //注册事件\r\n        addHandler:function(event,fn){\r\n            if(this.handlers[event]){\r\n                console.log(\"event:\" + event + \"' handler has been registered.\");\r\n                return;\r\n            }\r\n            var handler = function(data){\r\n                console.log(event + \"(\" + typeof(data) + \"):\" + (data? data.toString():\"null\"));\r\n                if(event != \"disconnect\" && typeof(data) == \"string\"){\r\n                    data = JSON.parse(data);\r\n                }\r\n                fn(data);\r\n            };\r\n            \r\n            this.handlers[event] = handler; \r\n            if(this.sio){\r\n                console.log(\"register:function \" + event);\r\n                this.sio.on(event,handler);\r\n            }\r\n        },\r\n        //创建连接\r\n        connect:function(fnConnect,fnError) {\r\n            var self = this;\r\n            var opts = {\r\n                'reconnection':false,\r\n                'force new connection': true,\r\n                'transports':['websocket', 'polling']\r\n            }\r\n            this.sio = window.io.connect(this.ip,opts);\r\n            \r\n            //监听\r\n            this.sio.on('reconnect',function(){\r\n                console.log('reconnection');\r\n            });\r\n            this.sio.on('connect',function(data){\r\n                self.sio.connected = true;\r\n                fnConnect(data);\r\n            });\r\n            this.sio.on('disconnect',function(data){\r\n                console.log(\"disconnect\");\r\n                self.sio.connected = false;\r\n                self.close();\r\n            });\r\n            this.sio.on('connect_failed',function (){\r\n                console.log('connect_failed');\r\n            });\r\n            \r\n            for(var key in this.handlers){\r\n                var value = this.handlers[key];\r\n                if(typeof(value) == \"function\"){\r\n                    if(key == 'disconnect'){\r\n                        this.fnDisconnect = value;\r\n                    }\r\n                    else{\r\n                        console.log(\"register:function \" + key);\r\n                        this.sio.on(key,value);                        \r\n                    }\r\n                }\r\n            }\r\n            this.startHearbeat();\r\n        },\r\n        //心跳\r\n        startHearbeat:function(){\r\n            this.sio.on('game_pong',function(){\r\n                console.log('game_pong');\r\n                self.lastRecieveTime = Date.now();\r\n                self.delayMS = self.lastRecieveTime - self.lastSendTime;\r\n                console.log(self.delayMS);\r\n            });\r\n            this.lastRecieveTime = Date.now();\r\n            var self = this;\r\n\r\n            if(!self.isPinging){\r\n                self.isPinging = true;\r\n                cc.game.on(cc.game.EVENT_HIDE,function(){\r\n                    self.ping();\r\n                });\r\n                setInterval(function(){\r\n                    if(self.sio){\r\n                        self.ping();                \r\n                    }\r\n                }.bind(this),5000);\r\n                setInterval(function(){\r\n                    if(self.sio){\r\n                        if(Date.now() - self.lastRecieveTime > 10000){\r\n                            self.close();\r\n                        }         \r\n                    }\r\n                }.bind(this),500);\r\n            }   \r\n        },\r\n        //发送数据\r\n        send:function(event,data){\r\n            if(this.sio.connected){\r\n                if(data != null && (typeof(data) == \"object\")){\r\n                    data = JSON.stringify(data);            \r\n                }\r\n                this.sio.emit(event,data);                \r\n            }\r\n        },\r\n        //ping\r\n        ping:function(){\r\n            if(this.sio){\r\n                this.lastSendTime = Date.now();\r\n                this.send('game_ping');\r\n            }\r\n        },\r\n        //断开连接\r\n        close:function(){\r\n            this.delayMS = null;\r\n            if(this.sio && this.sio.connected){\r\n                this.sio.connected = false;\r\n                this.sio.disconnect();\r\n            }\r\n            this.sio = null;\r\n            if(this.fnDisconnect){\r\n                this.fnDisconnect();\r\n                this.fnDisconnect = null;\r\n            }\r\n        },\r\n    },\r\n});\r\nmodule.exports = NetMgr;\r\n"]}